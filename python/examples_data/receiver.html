<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC Stream Receiver</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <main>
    <h1>WebRTC Stream Receiver</h1>
    <div class="controls">
      <input type="text" value="ws://localhost:8830" id="url" />
      <button id="button">Connect</button>
    </div>
    <div id="status"></div>
    <div class="video-wrapper">
      <video id="videoPlayer" controls autoplay muted playsinline></video>
    </div>
  </main>
  <script>
    const button = document.getElementById("button");
    const connStatus = document.getElementById("status");
    const urlInput = document.getElementById("url");
    const videoPlayer = document.getElementById("videoPlayer");

    const pcConfig = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };

    let pc = null;
    let ws = null;

    const updateStatus = (message, stateClass) => {
        connStatus.innerText = message;
        connStatus.className = stateClass || '';
    };

    const connect = () => {
      button.disabled = true;
      urlInput.disabled = true;
      updateStatus("Connecting...", "status-connecting");

      if (ws) {
        ws.onopen = ws.onclose = ws.onerror = null;
        ws.close();
      }

      try {
        ws = new WebSocket(urlInput.value);
      } catch (e) {
        console.error("Failed to create WebSocket:", e);
        updateStatus("Error: Invalid WebSocket URL", "status-disconnected");
        resetUI();
        return;
      }

      ws.onopen = () => {
        console.log("WebSocket opened.");
        connectRTC();
      };

      ws.onclose = event => {
        console.log("WebSocket connection was terminated:", event);
        updateStatus("Disconnected", "status-disconnected");
        if (pc) {
            pc.close();
            pc = null;
        }
        // Clear the video player
        videoPlayer.srcObject = null;
        resetUI();
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        updateStatus("Connection Error", "status-disconnected");
      };
    };

    const connectRTC = () => {
      pc = new RTCPeerConnection(pcConfig);

      videoPlayer.srcObject = new MediaStream();
      pc.ontrack = event => {
        console.log("Received track:", event.track);
        videoPlayer.srcObject.addTrack(event.track);
      };

      pc.onicecandidate = event => {
        if (event.candidate === null) return;
        ws.send(JSON.stringify({ type: "ice_candidate", data: event.candidate }));
      };

      pc.onconnectionstatechange = () => {
        console.log("PeerConnection state:", pc.connectionState);
        if (pc.connectionState == "connected") {
          updateStatus("Connected", "status-connected");
          button.innerHTML = "Disconnect";
          button.disabled = false;
          button.onclick = disconnect;
        } else if (["disconnected", "failed", "closed"].includes(pc.connectionState)) {
          ws.close();
        }
      };

      ws.onmessage = async event => {
        try {
          const { type, data } = JSON.parse(event.data);

          switch (type) {
            case "sdp_offer":
              console.log("Received SDP offer");
              await pc.setRemoteDescription(new RTCSessionDescription(data));
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              ws.send(JSON.stringify({ type: "sdp_answer", data: answer }));
              console.log("Sent SDP answer");
              break;
            case "ice_candidate":
              console.log("Received ICE candidate");
              await pc.addIceCandidate(new RTCIceCandidate(data));
              break;
          }
        } catch(err) {
            console.error("Error processing message:", err);
        }
      };
    };

    const disconnect = () => {
      console.log("Disconnecting...");
      button.disabled = true;
      if (ws) {
          ws.close();
      }
    };

    const resetUI = () => {
      button.disabled = false;
      urlInput.disabled = false;
      button.innerHTML = "Connect";
      button.onclick = connect;
    };

    button.onclick = connect;
  </script>
</body>
</html>
